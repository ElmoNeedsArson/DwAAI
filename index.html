<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Interactive Page</title>
    <link rel="stylesheet" href="css/styles.css">
</head>

<body>
    <div id="landingScreen" class="screen active">
        <button class="topBtn ripple-button" onclick="goToScreen('newBook'); newBook()">
            <div class="inner-circle top">
                <span class="button-text">New Book</span>
            </div>
        </button>
        <button class="btmBtn ripple-button" onclick="goToScreen('bookLibrary'); fetchBooks();">
            <div class="inner-circle btm">
                <span class="button-text">Book library</span>
            </div>
        </button>
    </div>

    <div id="newBook" class="screen">
        <button class="wholePageBtn nextPageBtn ripple-button">
            <div class="inner-circle full">
                <span class="button-text">Next page</span>
            </div>
        </button>
    </div>

    <div id="bookLibrary" class="screen">
        <div id="book-list"></div>
    </div>

    <div id="interruptChoice" class="screen">
        <button class="topBtn ripple-button" onclick="interrupts(true);">
            <div class="inner-circle top">
                <span class="button-text">Allow Interrupts</span>
            </div>
        </button>
        <button class="btmBtn ripple-button" onclick="interrupts(false);">
            <div class="inner-circle btm">
                <span class="button-text">No Interrupts</span>
            </div>
        </button>
    </div>

    <div id="bookStart" class="screen">
        <button class="leftBtn ripple-button" onclick="startBookListening(false)">
            <div class="inner-circle left">
                <span class="button-text">Previous Page</span>
            </div>
        </button>
        <button class="rightBtn ripple-button" onclick="startBookListening(true)">
            <div class="inner-circle right">
                <span class="button-text">Next Page</span>
            </div>
        </button>
        <!-- <button class="wholePageBtn nextPageBtnRead" onclick="startBookListening();">Play Audio Next page</button> -->
    </div>

    <!-- <div id="screen2" class="screen">
        <div class="container">
            <h1>Analyze book</h1>
            
            <div class="file-upload">
                <input type="file" id="fileInput" onchange="handleFileSelect(event)" />
                <button id="fileButton" onclick="uploadImage()">Upload Image</button>
            </div>

            <div id="loadercontainer">
                <div class="loader"></div>
            </div>

            <div id="errorContainer">
                <div class="error">Couldn't Detect any text on the Provided Image</div>
            </div>

            <div id="audioindicatercontainer">
                <div id="playing">
                    <span class="playing__bar playing__bar1"></span>
                    <span class="playing__bar playing__bar2"></span>
                    <span class="playing__bar playing__bar3"></span>
                </div>
            </div>

            <button onclick="goToScreen('screen2')">Screen1</button>

            <div id="camera-container">
                <video id="camera" autoplay playsinline></video>
            </div>
            <button id="captureButton">Take Picture</button>
            <button id="stopCamera" onclick="startCamera()">Start Camera</button>
            <button id="stopCamera" onclick="stopCamera()">Stop Camera</button>
            <canvas id="photoCanvas" width="640" height="480" style="display: none;"></canvas>
            <button id="captureButton">Active Reading Mode</button>
        </div>
    </div>

    <div id="screen3" class="screen">
        <div class="container">

            <h1>Screen 2</h1>
            <button onclick="goToScreen('screen1')">Screen1</button>
            <button onclick="testPyCam()">Test py cam</button>
        </div>
    </div> -->

    <script>
        document.querySelectorAll('.ripple-button').forEach(button => {
            button.addEventListener('click', function (event) {
                const ripple = document.createElement('span');
                const rect = button.getBoundingClientRect();
                const size = Math.max(button.offsetWidth, button.offsetHeight);
                const x = event.clientX - rect.left - size / 2;
                const y = event.clientY - rect.top - size / 2;

                ripple.style.width = ripple.style.height = `${size}px`;
                ripple.style.left = `${x}px`;
                ripple.style.top = `${y}px`;
                ripple.className = 'ripple';

                button.appendChild(ripple);

                ripple.addEventListener('animationend', () => ripple.remove());
            });
        });


    </script>

    <script>
        function interrupts(allow) {
            pywebview.api.interruptsPy(allow)
        }

        function fetchActiveBook() {
            return activeBook
        }

        function startBookListening(next) {
            //detect single or double click
            const now = new Date().getTime();
            const timeSinceLastClick = now - lastClickTime;
            lastClickTime = now;

            if (timeSinceLastClick < 300) {
                console.log("double click");
                console.log("end reading activity")
                goToScreen("landingScreen")
                stopAudio()
                // Double-click code here
            } else {
                setTimeout(() => {
                    if (now === lastClickTime) {
                        console.log("single click");
                        pywebview.api.startListening(next)
                    }
                }, 300);
            }
        }

        const bookList = document.getElementById("book-list");
        let currentIndex = 0;
        const audioPlayer = new Audio();
        let currentAudio = null;
        //let targetIndex = 0; // Keep track of the intended target
        let booksJS = []

        let activeBook = ""

        // IntersectionObserver
        const observer = new IntersectionObserver((entries) => {
            entries.forEach((entry) => {
                if (entry.isIntersecting) {
                    const bookName = entry.target.innerText;
                    activeBook = bookName
                    const audioFile = `books/${bookName}.mp3`;

                    // Play the audio for the target book
                    if (currentAudio !== audioFile) {
                        console.log(`Playing audio for: ${bookName}`);
                        currentAudio = audioFile;
                        audioPlayer.src = audioFile;
                        audioPlayer.play().catch((err) => {
                            console.error("Error playing audio:", err);
                        });
                    }
                }
            });
        }, { root: bookList, threshold: 0.8 });

        // Scroll to the next book on click
        let targetIndex = 0; // Keep track of the intended target
        let lastClickTime = 0;
        bookList.addEventListener("click", () => {
            const now = new Date().getTime();
            const timeSinceLastClick = now - lastClickTime;
            lastClickTime = now;

            if (timeSinceLastClick < 300) {
                console.log("double click -> Selected book: " + activeBook);
                goToScreen('interruptChoice')
                // Double-click code here
            } else {
                setTimeout(() => {
                    if (now === lastClickTime) {
                        console.log("single click -> next book");
                        const totalBooks = bookList.children.length;
                        const isWrapAround = targetIndex === totalBooks - 1; // Check if we're at the last book

                        // Disconnect observer if wrapping around
                        if (isWrapAround) {
                            observer.disconnect(); // Temporarily stop observing
                        }

                        targetIndex = (targetIndex + 1) % booksJS.length; // Move to the next book
                        const nextBook = bookList.children[targetIndex];
                        nextBook.scrollIntoView({
                            behavior: "smooth",
                            block: "nearest",
                            inline: "start",
                        });

                        // Reconnect observer after the scroll completes
                        setTimeout(() => {
                            if (isWrapAround) {
                                console.log("Reconnecting observer after wrap-around");
                                Array.from(bookList.children).forEach((book) => observer.observe(book));
                            }
                        }, 500); // Adjust timeout to match the scroll animation duration
                        // Single-click code here
                    }
                }, 300);
            }
        });

        console.log("Run script")
        const nextPageBtn = document.querySelector(".nextPageBtn");

        if (nextPageBtn) {
            console.log("element here");

            let lastClickTime = 0;

            nextPageBtn.addEventListener('click', event => {
                const now = new Date().getTime();
                const timeSinceLastClick = now - lastClickTime;
                lastClickTime = now;

                if (timeSinceLastClick < 300) {
                    console.log("double click");
                    endBook()
                    // Double-click code here
                } else {
                    setTimeout(() => {
                        if (now === lastClickTime) {
                            console.log("single click");
                            nextPage()
                            // Single-click code here
                        }
                    }, 300);
                }
            });
        } else {
            console.log("No element found");
        }

        function testPyCam() {
            pywebview.api.py_cam()
        }

        function goToScreen(screenId) {
            document.querySelectorAll('.screen').forEach(screen => {
                screen.classList.remove('active');
            })

            document.getElementById(screenId).classList.add('active')
        }

        function newBook() {
            pywebview.api.newBook()
        }

        function nextPage() {
            pywebview.api.nextPage()
        }

        function endBook() {
            pywebview.api.endBook()
        }

        function fetchBooks() {
            pywebview.api.fetchBooks()
        }

        function createBookDivs(bookArray) {
            booksJS = bookArray
            const bookList = document.getElementById('book-list');
            bookArray.forEach(book => {
                const div = document.createElement('div');
                div.className = 'book-div';
                div.innerText = book;
                bookList.appendChild(div);
                observer.observe(div);
            });
        }


        const video = document.getElementById('camera');
        const canvas = document.getElementById('photoCanvas');
        const captureButton = document.getElementById('captureButton');
        const cameraContainer = document.getElementById('camera-container');
        const fileInput = document.getElementById('fileInput');

        let cameraStream = null;

    //     function startCamera() {
    //         // Access the user's webcam
    //         navigator.mediaDevices.getUserMedia({ video: true })
    //             .then(stream => {
    //                 video.srcObject = stream;
    //                 cameraStream = stream;
    //             })
    //             .catch(error => {
    //                 console.error('Error accessing the camera', error);
    //             });
    //     }

    //     function stopCamera() {
    //         if (cameraStream) {
    //             cameraStream.getTracks().forEach(track => track.stop());
    //             video.srcObject = null;
    //         } else {
    //             console.log('Camera stream is not active')
    //         }
    //     }

    //     captureButton.addEventListener('click', () => {
    //         const context = canvas.getContext('2d');
    //         context.drawImage(video, 0, 0, canvas.width, canvas.height);

    //         // Get image data as a Base64 string
    //         const imageData = canvas.toDataURL('image/png');

    //         // Add flash effect to the camera container
    //         cameraContainer.classList.add('flash');
    //         setTimeout(() => {
    //             cameraContainer.classList.remove('flash');
    //         }, 300);  // Remove flash effect after animation completes

    //         // Convert canvas to a blob
    //         canvas.toBlob(blob => {
    //             const file = new File([blob], 'captured_image.png', { type: 'image/png' });

    //             // Simulate file selection using DataTransfer
    //             const dataTransfer = new DataTransfer();
    //             dataTransfer.items.add(file);
    //             fileInput.files = dataTransfer.files;
    //         });

    //         // Send the image data to the backend using PyWebView's API
    //         window.pywebview.api.save_picture(imageData);
    //     });
    </script>

    <script>
        //My autism lets me use the standard console log with this function -> app.py also has a function for this
        console.log = function (message) {
            pywebview.api.log_message(message);
        };

        let audio;

        function displayError() {
            const errorContainerEl = document.getElementById("errorContainer")
            errorContainerEl.style.display = 'flex'
            hideLoader()
        }

        function hideLoader() {
            const loaderEl = document.getElementById("loadercontainer")
            loaderEl.style.display = 'none'
        }

        function showLoader() {
            const loaderEl = document.getElementById("loadercontainer")
            loaderEl.style.display = 'flex'
        }

        let currentAudio2 = null;

        // Function to play audio
        function playAudio(path) {
            stopAudio();  // Stop any currently playing audio

            currentAudio2 = new Audio(path);
            console.log("clicked play audio");
            console.log(path);

            currentAudio2.play().catch(error => {
                console.log('Error playing audio:', error);
            });

            currentAudio2.addEventListener("ended", function () {
                currentAudio2.currentTime = 0;
                console.log("Audio ended");
            });
        }

        function stopAudio() {
            if (currentAudio2) {
                currentAudio2.pause();
                currentAudio2.currentTime = 0;
                console.log("Audio stopped");
            }
        }

        // function stopAudio() {
        //     if (audio) {
        //         audio.pause();
        //         audio.currentTime = 0;  // Reset to start
        //     }
        // }

        // Handle image file selection
        let selectedImage = null;
        function handleFileSelect(event) {
            selectedImage = event.target.files[0];  // Get the selected file
            if (selectedImage) {
                console.log("File selected: " + selectedImage.name);
            }
        }

        // Upload image to Python
        // function uploadImage() {
        //     const fileInput = document.getElementById("fileInput")
        //     //handleFileSelect()
        //     //console.log(fileInput.files[0])
        //     selectedImage = fileInput.files[0]
        //     if (selectedImage) {
        //         console.log("File selected: " + selectedImage.name);
        //     }
        //     const errorContainerEl = document.getElementById("errorContainer")
        //     errorContainerEl.style.display = 'none'
        //     showLoader()
        //     if (!selectedImage) {
        //         console.log("No image selected");
        //         return;
        //     }

        //     const reader = new FileReader();
        //     reader.onload = function (event) {
        //         const base64Image = event.target.result;  // Image as base64 string
        //         pywebview.api.process_image(base64Image).then(response => {
        //             console.log("Image processed successfully", response);
        //         }).catch(error => {
        //             console.log("Error processing image", error);
        //         });
        //     };
        //     reader.readAsDataURL(selectedImage);  // Convert image to base64
        // }

        // async function getAnswer() {
        //     let inputField = document.getElementById('input_field').value;
        //     console.log("PASSED")
        //     try {
        //         let response = await pywebview.api.show_response(inputField);

        //         if (response.message) {
        //             document.getElementById('response-block-text').innerText = response.message;
        //         }
        //     } catch (error) {
        //         console.log('Error');
        //     }
        // }
    </script>
</body>

</html>